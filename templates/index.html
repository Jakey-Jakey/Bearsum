<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Summarizer & Storyteller - Bearhacks Edition</title> {# Updated Title #}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <header class="app-header">
        <h1>Pocket Summarizer & Storyteller <span class="theme-accent">(Bearhacks Edition)</span></h1> {# Updated Title #}
    </header>

    <div class="container">

        <!-- Display Flashed Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-messages">
              {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Upload Form Section (Summarizer) -->
        <section class="upload-section">
            <h2>Summarize Your Notes</h2> {# Clarify purpose #}
            <p>Drag & drop your notes (.txt, .md) or browse.</p>
            <div class="file-info">
                Max files: {{ config.MAX_FILES }}, Max size per file: {{ config.MAX_FILE_SIZE_MB }}MB
            </div>

            <form method="post"
                  enctype="multipart/form-data"
                  class="upload-form"
                  id="upload-form" {# Keep ID for JS? Or rename? Keep for now. #}
                  action="{{ url_for('process_files') }}"
                  data-max-files="{{ config.MAX_FILES }}"
                  data-max-file-size-mb="{{ config.MAX_FILE_SIZE_MB }}"
                  {# Remove processing state from this form, handle via specific task IDs #}
                  >
                <input type="file" id="files" name="files" multiple required accept=".txt,.md" class="visually-hidden">
                <div id="drop-zone" class="drop-zone">
                    <p>Drag & Drop Files Here</p>
                    <p>or</p>
                    <a href="#" id="browse-files-link" class="btn btn-browse">Browse Files</a>
                </div>
                <div id="file-list-display" class="file-list-display">
                    <p><em>No files selected. Drag & drop or browse.</em></p>
                </div>
                <div class="form-group">
                    <label>Summary Detail Level:</label>
                    <div class="radio-group ghost-buttons">
                        <label>
                            <input type="radio" name="summary_level" value="short" class="visually-hidden">
                            <span>Short</span>
                        </label>
                        <label>
                            <input type="radio" name="summary_level" value="medium" checked class="visually-hidden">
                            <span>Medium</span>
                        </label>
                        <label>
                            <input type="radio" name="summary_level" value="comprehensive" class="visually-hidden">
                            <span>Comprehensive</span>
                        </label>
                    </div>
                </div>
                <div class="form-group submit-group">
                    {# Add data attribute to identify task type #}
                    <button type="submit" class="btn btn-submit" id="submit-button-summary" data-task-type="summary">Summarize Files</button>
                </div>
            </form>
        </section>

        {# --- NEW Story Generator Section --- #}
        <section class="story-section upload-section"> {# Reuse upload-section style #}
            <h2>Generate Your Bearhacks Story</h2>
            <p>Paste your public GitHub repository URL to generate a fictional story based on recent commits.</p>

            <form method="post"
                  class="story-form upload-form" {# Reuse upload-form style #}
                  id="story-form"
                  action="{{ url_for('generate_story') }}"
                  >
                <div class="form-group">
                     <label for="github_url">GitHub Repository URL:</label>
                     <input type="url" id="github_url" name="github_url" required
                            placeholder="https://github.com/owner/repo"
                            class="form-control" {# Add a basic form control style #}
                            >
                </div>
                 <div class="form-group submit-group">
                     {# Add data attribute to identify task type #}
                    <button type="submit" class="btn btn-submit" id="submit-button-story" data-task-type="story">Generate Story</button> {# Removed inline style #}
                </div>
            </form>
        </section>


        <!-- Processing Indicator Section (Generic) -->
        {# Use one indicator, update text based on active task #}
        <div id="processing-indicator-wrapper" class="processing-indicator-wrapper {% if not is_processing_summary and not is_processing_story %}hidden{% endif %}">
            <section id="processing-indicator" class="processing-indicator">
                 <div class="spinner"></div>
                 <p id="processing-task-name">Processing...</p> {# Placeholder text #}
                 <div class="status-log live-status-area" id="live-status-log">
                     <h4>Live Status:</h4>
                     <p id="latest-status" class="latest-status-message">Initializing...</p>
                 </div>
            </section>
        </div>

        <!-- Results Section (Combined) -->
        {# Show results from either task #}
        <div id="results-container-wrapper" class="results-container-wrapper {% if not summary_html and not summary_raw and not story_html and not story_raw %}hidden{% endif %}">
            <section class="results-container" id="results-area">

                {# --- Summary Results --- #}
                {% if summary_html or summary_raw %}
                    <div class="results-area summary-section">
                        <h2>Summary Result</h2> {# Clarify which result #}
                        <div class="view-toggle">
                            <button type="button" class="btn btn-toggle active" data-view="rendered" data-target="summary">Rendered View</button>
                            <button type="button" class="btn btn-toggle" data-view="raw" data-target="summary">Raw Text</button>
                        </div>
                        <!-- Wrapper for view toggle transition -->
                        <div class="summary-view-wrapper" id="summary-view-wrapper">
                            <div id="summary-rendered" class="summary-rendered">
                                {% if summary_html %}{{ summary_html | safe }}{% else %}<p><em>(Could not render summary)</em></p>{% endif %}
                            </div>
                            <div id="summary-raw" class="summary-raw hidden">
                                <pre id="summary-text-raw">{{ summary_raw }}</pre>
                            </div>
                        </div>
{# templates/index.html - Snippet #}

                        <div class="action-buttons">
                             <button type="button" id="copy-button-summary" class="btn btn-copy" data-target="summary-text-raw">Copy Raw Text</button>
                             {# --- CORRECTED CONDITION --- #}
                             {# Only show download if summary_raw has valid content (not None/empty) #}
                             {% if summary_raw %}
                             <a href="{{ url_for('download_summary') }}" class="btn btn-download">Download Raw (.txt)</a>
                             {% endif %}
                             {# --- END CORRECTION --- #}
                        </div>
                    </div>
                {% endif %}

                {# --- Story Results --- #}
                {% if story_html or story_raw %}
                    <div class="results-area story-section">
                        <h2>Story Result</h2> {# Clarify which result #}
                        {# Maybe add view toggle later if needed #}
                        <div id="story-rendered" class="summary-rendered"> {# Reuse style #}
                             {% if story_html %}{{ story_html | safe }}{% else %}<p><em>{{ story_raw if story_raw else '(Could not render story)' }}</em></p>{% endif %}
                        </div>
                         {# Add copy/download later if desired #}
                         <div class="action-buttons">
                             {# Use innerText of the rendered div for copy #}
                             <button type="button" id="copy-button-story" class="btn btn-copy" data-target="story-rendered">Copy Story Text</button>
                         </div>
                    </div>
                {% endif %}

            </section>
        </div>

    </div> <!-- /container -->

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Element References (Keep all previous references) ---
            const summaryForm = document.getElementById('upload-form');
            const storyForm = document.getElementById('story-form');
            const submitButtonSummary = document.getElementById('submit-button-summary');
            const submitButtonStory = document.getElementById('submit-button-story');
            const processingIndicatorWrapper = document.getElementById('processing-indicator-wrapper');
            const processingTaskName = document.getElementById('processing-task-name');
            const resultsContainerWrapper = document.getElementById('results-container-wrapper');
            const latestStatusElement = document.getElementById('latest-status');
            const summaryViewWrapper = document.getElementById('summary-view-wrapper');
            const summaryRenderedView = document.getElementById('summary-rendered');
            const summaryRawView = document.getElementById('summary-raw');
            const summaryRawTextElement = document.getElementById('summary-text-raw');
            const summaryViewToggles = document.querySelectorAll('.summary-section .view-toggle .btn-toggle');
            const copyButtonSummary = document.getElementById('copy-button-summary');
            const storyRenderedView = document.getElementById('story-rendered');
            const copyButtonStory = document.getElementById('copy-button-story');
            const fileInput = document.getElementById('files');
            const dropZone = document.getElementById('drop-zone');
            const fileListDisplay = document.getElementById('file-list-display');
            const browseFilesLink = document.getElementById('browse-files-link');
            const githubUrlInput = document.getElementById('github_url');

            // --- Config (Keep previous) ---
            const MAX_FILES = parseInt(summaryForm?.dataset.maxFiles || '5');
            const MAX_FILE_SIZE_MB = parseInt(summaryForm?.dataset.maxFileSizeMb || '1');
            // ... rest of config ...
            const ALLOWED_EXTENSIONS = ['txt', 'md'];

            // --- Initial State from Flask (Keep previous) ---
            const isProcessingSummary = {{ is_processing_summary | tojson }};
            const isProcessingStory = {{ is_processing_story | tojson }};
            const summaryTaskId = "{{ summary_task_id if summary_task_id else '' }}";
            const storyTaskId = "{{ story_task_id if story_task_id else '' }}";
            let activeTaskId = isProcessingSummary ? summaryTaskId : (isProcessingStory ? storyTaskId : null);
            let activeTaskType = isProcessingSummary ? 'summary' : (isProcessingStory ? 'story' : null);
            let eventSource = null;

            console.log("Initial State:", { isProcessingSummary, isProcessingStory, summaryTaskId, storyTaskId, activeTaskId, activeTaskType });

            // --- Helper: Update File List Display (Keep previous) ---
            function updateFileList(files) { /* ... Keep previous implementation ... */
                 if (!fileListDisplay) return;
                 fileListDisplay.innerHTML = '';
                 if (!files || files.length === 0) {
                     fileListDisplay.innerHTML = '<p><em>No files selected. Drag & drop or browse.</em></p>'; return;
                 }
                 const list = document.createElement('ul');
                 Array.from(files).forEach((file, index) => {
                     const li = document.createElement('li');
                     let errorMsg = '';
                     const fileExt = file.name.split('.').pop()?.toLowerCase() || '';
                     if (file.size > (MAX_FILE_SIZE_MB * 1024 * 1024)) { errorMsg = ` <span class="file-error">(Too large)</span>`; }
                     else if (!ALLOWED_EXTENSIONS.includes(fileExt)) { errorMsg = ` <span class="file-error">(Invalid type)</span>`; }
                     li.innerHTML = `${file.name} <span class="file-size">(${(file.size / 1024).toFixed(1)} KB)</span>${errorMsg}`;
                     if (errorMsg) li.classList.add('has-error');
                     li.style.animationDelay = `${index * 0.05}s`;
                     list.appendChild(li);
                 });
                 if (files.length > MAX_FILES) {
                     const errorLi = document.createElement('li');
                     errorLi.innerHTML = `<span class="file-error">Error: Too many files (max ${MAX_FILES}).</span>`;
                     errorLi.classList.add('has-error');
                     errorLi.style.animationDelay = `${files.length * 0.05}s`;
                     list.appendChild(errorLi);
                 }
                 fileListDisplay.appendChild(list);
            }

             // --- Helper: Validate Files (Keep previous) ---
             function validateFiles(files) { /* ... Keep previous implementation ... */
                  if (!files || files.length === 0) return false;
                  if (files.length > MAX_FILES) return false;
                  for (const file of files) {
                      const fileExt = file.name.split('.').pop()?.toLowerCase() || '';
                      if (file.size > (MAX_FILE_SIZE_MB * 1024 * 1024) || !ALLOWED_EXTENSIONS.includes(fileExt)) return false;
                  }
                  return true;
             }

            // --- Helper: Show/Hide Wrappers (Simplified CSS assumed) ---
            function showElementWrapper(wrapper) {
                if (wrapper) {
                    console.log("Showing wrapper:", wrapper.id);
                    wrapper.classList.remove('hidden');
                } else {
                    console.error("Attempted to show null wrapper");
                }
            }
            function hideElementWrapper(wrapper) {
                if (wrapper) {
                    console.log("Hiding wrapper:", wrapper.id);
                    wrapper.classList.add('hidden');
                } else {
                     console.error("Attempted to hide null wrapper");
                }
            }

            // --- Helper: Set View Wrapper Height (Keep previous) ---
            function setViewWrapperHeight(wrapper, viewSelector = ':not(.hidden)') { /* ... Keep previous implementation ... */
                 if (!wrapper) return;
                 const activeView = wrapper.querySelector(viewSelector);
                 if (activeView) {
                     wrapper.style.minHeight = `${activeView.scrollHeight + 10}px`;
                 } else {
                     wrapper.style.minHeight = '100px';
                 }
            }

            // --- Drag and Drop Helpers (Keep previous) ---
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            function highlight(e) { dropZone?.classList.add('dragover'); }
            function unhighlight(e) { dropZone?.classList.remove('dragover'); }
            function handleDrop(e) { /* ... Keep previous implementation ... */
                 const dt = e.dataTransfer; const files = dt.files;
                 try { fileInput.files = files; updateFileList(files); }
                 catch (err) { console.error("Error setting files:", err); alert("Drop error."); updateFileList(null); }
            }


            // --- Drag and Drop Logic (Keep previous) ---
            if (dropZone && fileInput && fileListDisplay) { /* ... Keep previous implementation ... */
                  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => { dropZone.addEventListener(ev, preventDefaults, false); document.body.addEventListener(ev, preventDefaults, false); });
                  ['dragenter', 'dragover'].forEach(ev => dropZone.addEventListener(ev, highlight, false));
                  ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, unhighlight, false));
                  dropZone.addEventListener('drop', handleDrop, false);
                  if (browseFilesLink) browseFilesLink.addEventListener('click', (e) => { e.preventDefault(); fileInput.click(); });
                  dropZone.addEventListener('click', (e) => { if (!browseFilesLink || e.target.isSameNode(browseFilesLink)) {} else {fileInput.click();} }); // Fixed logic
                  fileInput.addEventListener('change', function() { updateFileList(this.files); });
                  updateFileList(fileInput.files);
            }


            // --- SSE Connection Function (Keep previous) ---
            function connectSSE(taskId, taskType) { /* ... Keep previous implementation ... */
                if (!taskId || !processingIndicatorWrapper || !resultsContainerWrapper || !latestStatusElement) return;
                if (eventSource) { console.log("Closing existing SSE connection."); eventSource.close(); eventSource = null; }

                console.log(`Connecting to SSE stream for ${taskType} task: ${taskId}`);
                eventSource = new EventSource(`/stream?channel=${taskId}`);
                activeTaskId = taskId;
                activeTaskType = taskType;

                eventSource.onopen = function() {
                    console.log("SSE connection opened.");
                    showElementWrapper(processingIndicatorWrapper);
                    hideElementWrapper(resultsContainerWrapper);
                    if (processingTaskName) processingTaskName.textContent = taskType === 'summary' ? 'Summarizing Files...' : 'Generating Story...';
                    latestStatusElement.textContent = 'Connection established... waiting for updates.';
                    latestStatusElement.classList.remove('animate-new');
                    latestStatusElement.style.color = '';
                    if(submitButtonSummary) submitButtonSummary.disabled = true;
                    if(submitButtonStory) submitButtonStory.disabled = true;
                };

                eventSource.onmessage = function(event) {
                     console.log("SSE message received:", event.data);
                     console.log("Target URL:", event.target.url, "Active Task ID:", activeTaskId);
                    try {
                        const data = JSON.parse(event.data);
                        // Ensure message is for the active task
                        if (activeTaskId && event.target.url.includes(activeTaskId)) {
                            if (data.type === 'status' && latestStatusElement) {
                                console.log("Updating status:", data.message);
                                latestStatusElement.textContent = data.message;
                                latestStatusElement.classList.remove('animate-new');
                                void latestStatusElement.offsetWidth;
                                latestStatusElement.classList.add('animate-new');
                            }
                            if (data.type === 'completed' || data.type === 'error') {
                                console.log(`Task ${activeTaskId} ${data.type}. Closing SSE and reloading.`);
                                if (eventSource) { eventSource.close(); eventSource = null; }
                                latestStatusElement.textContent = `${taskType.charAt(0).toUpperCase() + taskType.slice(1)} ${data.type}. Reloading results...`;
                                // Clear active task info *before* reload
                                activeTaskId = null;
                                activeTaskType = null;
                                setTimeout(() => {
                                     console.log("Reloading page now.");
                                     window.location.reload();
                                 }, 1200);
                            }
                        } else {
                             console.warn(`Ignoring SSE message - Active Task ID mismatch or null. Active: ${activeTaskId}, Target URL: ${event.target.url}`);
                        }
                    } catch (e) {
                        console.error("Failed to parse SSE message or update UI:", e);
                         if(latestStatusElement) latestStatusElement.textContent = "Error processing status update.";
                    }
                };

                eventSource.onerror = function(err) {
                    console.error("SSE connection error:", err);
                    // Check if the error is relevant to the active task
                    if (activeTaskId && event.target.url.includes(activeTaskId)) {
                        if (latestStatusElement) {
                             latestStatusElement.textContent = "Status update connection failed. Please refresh manually for results.";
                             latestStatusElement.style.color = 'var(--color-error-text)';
                             latestStatusElement.classList.remove('animate-new');
                        }
                        hideElementWrapper(processingIndicatorWrapper);
                        if(submitButtonSummary) submitButtonSummary.disabled = false;
                        if(submitButtonStory) submitButtonStory.disabled = false;
                        activeTaskId = null;
                        activeTaskType = null;
                    } else {
                         console.warn("SSE error occurred, but not for the active task or no task active.");
                    }
                    if (eventSource) { eventSource.close(); eventSource = null; }
                };
            }

            // --- Initial Page Load Logic (Keep previous, ensure buttons enabled) ---
            if (isProcessingSummary && summaryTaskId) {
                connectSSE(summaryTaskId, 'summary');
            } else if (isProcessingStory && storyTaskId) {
                connectSSE(storyTaskId, 'story');
            } else {
                hideElementWrapper(processingIndicatorWrapper);
                 if (resultsContainerWrapper && !resultsContainerWrapper.classList.contains('hidden')) {
                     showElementWrapper(resultsContainerWrapper);
                     if (summaryViewWrapper) { setViewWrapperHeight(summaryViewWrapper); }
                 }
                 if(submitButtonSummary) submitButtonSummary.disabled = false;
                 if(submitButtonStory) submitButtonStory.disabled = false;
            }

            // --- Form Submission Logic (REVISED) ---
            function handleFormSubmit(event, taskType) {
                 console.log(`Handling submit for task type: ${taskType}`);
                 event.preventDefault(); // Prevent default submission immediately

                 let isValid = false;
                 let loadingText = 'Processing...';
                 const formElement = event.target.closest('form');

                 // --- Validation ---
                 if (taskType === 'summary') {
                     const files = fileInput?.files;
                     isValid = validateFiles(files);
                     if (!isValid) {
                         alert("Please select valid files (check type, size, and count) before submitting.");
                         return; // Stop processing if invalid
                     }
                     loadingText = 'Summarizing Files...';
                 } else if (taskType === 'story') {
                     const url = githubUrlInput?.value?.trim(); // Trim whitespace
                     isValid = url && url.startsWith("https://github.com/"); // Basic check
                     if (!isValid) {
                         alert("Please enter a valid HTTPS GitHub repository URL (e.g., https://github.com/owner/repo).");
                         return; // Stop processing if invalid
                     }
                     loadingText = 'Generating Story...';
                 } else {
                      console.error("Unknown task type in handleFormSubmit:", taskType);
                      return; // Unknown task
                 }

                 // --- If Valid, Proceed ---
                 if (isValid) {
                     console.log("Form is valid. Disabling buttons and showing indicator.");
                     // Disable both buttons
                     if(submitButtonSummary) submitButtonSummary.disabled = true;
                     if(submitButtonStory) submitButtonStory.disabled = true;

                     // Show loading indicator and hide results
                     if (processingTaskName) processingTaskName.textContent = loadingText;
                     if (latestStatusElement) {
                         latestStatusElement.textContent = 'Submitting request...';
                         latestStatusElement.classList.remove('animate-new'); // Reset animation
                     }
                     showElementWrapper(processingIndicatorWrapper); // Show loader
                     hideElementWrapper(resultsContainerWrapper); // Hide results

                     // Submit the form programmatically AFTER UI updates
                     console.log("Submitting form:", formElement.id);
                     formElement.submit();
                 } else {
                      console.log("Form is invalid. Submission stopped.");
                      // Ensure buttons are enabled if validation failed after initial disable (shouldn't happen with current flow)
                      if(submitButtonSummary) submitButtonSummary.disabled = false;
                      if(submitButtonStory) submitButtonStory.disabled = false;
                 }
            }

            if (summaryForm && submitButtonSummary) {
                summaryForm.addEventListener('submit', (e) => handleFormSubmit(e, 'summary'));
            }
            if (storyForm && submitButtonStory) {
                 storyForm.addEventListener('submit', (e) => handleFormSubmit(e, 'story'));
            }

            // --- View Toggling Logic (Keep previous) ---
             if (summaryViewToggles.length > 0 && summaryRenderedView && summaryRawView && summaryViewWrapper) {
                 summaryViewToggles.forEach(button => { /* ... Keep previous implementation ... */
                     button.addEventListener('click', function() {
                         const viewToShow = this.getAttribute('data-view');
                         summaryViewToggles.forEach(btn => btn.classList.remove('active'));
                         this.classList.add('active');
                         if (viewToShow === 'rendered') {
                             summaryRenderedView.classList.remove('hidden');
                             summaryRawView.classList.add('hidden');
                         } else {
                             summaryRenderedView.classList.add('hidden');
                             summaryRawView.classList.remove('hidden');
                         }
                         setTimeout(() => setViewWrapperHeight(summaryViewWrapper), 50);
                     });
                 });
                 // Initial height setting done during page load logic
            }


            // --- Copy Button Logic (Keep previous) ---
            function handleCopyClick(button) { /* ... Keep previous implementation ... */
                  const targetId = button.getAttribute('data-target');
                  const targetElement = document.getElementById(targetId);
                  if (!targetElement) { console.error(`Copy target #${targetId} not found.`); return; }
                  let textToCopy = targetElement.innerText || targetElement.value || targetElement.textContent;
                  textToCopy = textToCopy?.trim();
                  if (!textToCopy) { console.warn(`No text in #${targetId} to copy.`); return; }
                  if (!navigator.clipboard) { alert('Clipboard API not available.'); return; }
                  navigator.clipboard.writeText(textToCopy).then(() => {
                      const originalText = button.innerText; button.innerText = 'Copied!'; button.disabled = true;
                      setTimeout(() => { button.innerText = originalText; button.disabled = false; }, 1500);
                  }, (err) => {
                      console.error('Copy failed: ', err); const originalText = button.innerText; button.innerText = 'Copy Failed';
                      setTimeout(() => { button.innerText = originalText; }, 1500);
                  });
            }

            [copyButtonSummary, copyButtonStory].forEach(button => { /* ... Keep previous implementation ... */
                 if (button) {
                     const targetId = button.getAttribute('data-target');
                     const targetElement = document.getElementById(targetId);
                     const content = targetElement?.innerText?.trim() || targetElement?.value?.trim() || targetElement?.textContent?.trim();
                     const isError = content?.startsWith("Error:") || content?.includes('(Could not render');
                     if (!targetElement || !content || isError) { button.style.display = 'none'; }
                     else { button.style.display = 'inline-block'; button.addEventListener('click', () => handleCopyClick(button)); }
                 }
            });


            // Recalculate view wrapper height on window resize
            window.addEventListener('resize', () => {
                 if (summaryViewWrapper && !summaryViewWrapper.classList.contains('hidden')) {
                    setViewWrapperHeight(summaryViewWrapper);
                 }
            });

        }); // End DOMContentLoaded
    </script>
</body>
</html>
